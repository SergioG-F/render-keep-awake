name: Keep Render Backend Awake

# 🚀 PROGRAMACIÓN:
# Ejecuta el workflow cada 5 minutos durante JULIO (7), AGOSTO (8) y SEPTIEMBRE (9),
# y hace un último ping el 30 de septiembre a las 23:59 UTC
on:
  schedule:
    - cron: '*/5 * * 7-9 *'      # ⏱️ Cada 5 minutos en julio, agosto y septiembre
    - cron: '59 23 30 9 *'       # 🛌 Último ping el 30/09 a las 23:59 UTC
  workflow_dispatch:             # ▶️ Permite ejecución manual desde GitHub Actions

jobs:
  ping-render:
    name: 🌐 Ping al backend en Render
    runs-on: ubuntu-latest
    steps:
      - name: ⏰ Ejecutando ping a Render backend
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "📡 Ping enviado a las $TIMESTAMP UTC"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://reception-back.onrender.com/)
          echo "📥 Código de respuesta: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "⚠️ Backend no respondió correctamente o está dormido"
          fi

  despedida:
    name: 🛌 Último ping del ciclo (despedida simbólica)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: ✅ Mensaje simbólico de cierre
        run: |
          HOY=$(date -u '+%m-%d %H:%M')
          if [ "$HOY" = "09-30 23:59" ]; then
            echo "🛑 Fin del ciclo: backend puede dormir a partir de ahora."
          else
            echo "🕓 Aún estamos dentro del rango de ejecución."
          fi

  auto-disable:
    name: 🚫 Autodesactivar GitHub Action (borrar este archivo)
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write    # ✅ Necesario para modificar el repositorio
    steps:
      - name: 🕵️ Verificar si es 30/09 a las 23:59
        id: verificar
        run: |
          HOY=$(date -u '+%m-%d %H:%M')
          echo "FECHA_ACTUAL=$HOY" >> $GITHUB_ENV
          if [ "$HOY" = "09-30 23:59" ]; then
            echo "desactivar=true" >> $GITHUB_OUTPUT
          else
            echo "desactivar=false" >> $GITHUB_OUTPUT
          fi

      - name: 🔧 Clonar el repositorio
        if: steps.verificar.outputs.desactivar == 'true'
        uses: actions/checkout@v4

      - name: 🗑️ Eliminar archivo keep-alive.yml
        if: steps.verificar.outputs.desactivar == 'true'
        run: |
          echo "🗂️ Eliminando archivo keep-alive.yml para detener futuros pings..."
          rm -f .github/workflows/keep-alive.yml

      - name: 📤 Commit y push del borrado
        if: steps.verificar.outputs.desactivar == 'true'
        run: |
          git config --global user.name "uptime-bot"
          git config --global user.email "uptime@githubactions.com"
          git add .github/workflows/keep-alive.yml || echo "Ya estaba borrado"
          git commit -m "🛑 Autoapagado: Fin del ciclo de pings a Render (sept 30)"
          git push
