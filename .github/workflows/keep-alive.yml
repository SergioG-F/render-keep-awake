name: Keep Render Backend Awake

# 🚀 PROGRAMACIÓN:
# Ejecuta el workflow cada 5 minutos durante JULIO 7, AGOSTO (8) y SEPTIEMBRE (9),
# y hace un último ping el 30 de septiembre a las 23:59 (UTC)
on:
  schedule:
    - cron: '*/5 * * 7-9 *'      # ⏱️ Cada 5 minutos en Julio, agosto y septiembre
    - cron: '59 23 30 9 *'       # 🛌 Último ping el 30 de septiembre

  workflow_dispatch:             # ▶️ Permite ejecución manual

jobs:
  ping-render:
    name: 🌐 Ping al backend en Render
    runs-on: ubuntu-latest
    steps:
      - name: ⏰ Ejecutando ping a Render backend
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "📡 Ping enviado a las $TIMESTAMP UTC"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://reception-back.onrender.com/)
          echo "📥 Código de respuesta: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "⚠️ Backend no respondió correctamente o está dormido"
          fi

  despedida:
    name: 🛌 Último ping del ciclo (despedida simbólica)
    if: github.event.schedule == '59 23 30 9 *'
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Último ping enviado. Tu backend puede descansar 😴
        run: echo "🛑 Fin del ciclo: backend puede dormir a partir de ahora."

  auto-disable:
    name: 🚫 Autodesactivar GitHub Action (borrar este archivo)
    if: github.event.schedule == '59 23 30 9 *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 🔧 Clonar el repositorio
        uses: actions/checkout@v4

      - name: 🗑️ Eliminar archivo keep-alive.yml
        run: |
          echo "Borrando este workflow para detener futuros pings..."
          rm -f .github/workflows/keep-alive.yml

      - name: 📤 Commit y push del borrado
        run: |
          git config --global user.name "uptime-bot"
          git config --global user.email "uptime@githubactions.com"
          git add .github/workflows/keep-alive.yml || echo "Ya estaba borrado"
          git commit -m "🛑 Autoapagado: Fin del ciclo de pings a Render (sept 30)"
          git push
