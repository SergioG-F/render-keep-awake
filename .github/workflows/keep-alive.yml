name: Keep Render Backend Awake

# ğŸš€ PROGRAMACIÃ“N:
# Ejecuta el workflow cada 5 minutos durante JULIO (7), AGOSTO (8) y SEPTIEMBRE (9),
# y hace un Ãºltimo ping el 30 de septiembre a las 23:59 UTC
on:
  schedule:
    - cron: '*/5 * * 7-9 *'      # â±ï¸ Cada 5 minutos en julio, agosto y septiembre
    - cron: '59 23 30 9 *'       # ğŸ›Œ Ãšltimo ping el 30/09 a las 23:59 UTC
  workflow_dispatch:             # â–¶ï¸ Permite ejecuciÃ³n manual desde GitHub Actions

jobs:
  ping-render:
    name: ğŸŒ Ping al backend en Render
    runs-on: ubuntu-latest
    steps:
      - name: â° Ejecutando ping a Render backend
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "ğŸ“¡ Ping enviado a las $TIMESTAMP UTC"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://reception-back.onrender.com/)
          echo "ğŸ“¥ CÃ³digo de respuesta: $RESPONSE"
          if [ "$RESPONSE" != "200" ]; then
            echo "âš ï¸ Backend no respondiÃ³ correctamente o estÃ¡ dormido"
          fi

  despedida:
    name: ğŸ›Œ Ãšltimo ping del ciclo (despedida simbÃ³lica)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: âœ… Mensaje simbÃ³lico de cierre
        run: |
          HOY=$(date -u '+%m-%d %H:%M')
          if [ "$HOY" = "09-30 23:59" ]; then
            echo "ğŸ›‘ Fin del ciclo: backend puede dormir a partir de ahora."
          else
            echo "ğŸ•“ AÃºn estamos dentro del rango de ejecuciÃ³n."
          fi

  auto-disable:
    name: ğŸš« Autodesactivar GitHub Action (borrar este archivo)
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write    # âœ… Necesario para modificar el repositorio
    steps:
      - name: ğŸ•µï¸ Verificar si es 30/09 a las 23:59
        id: verificar
        run: |
          HOY=$(date -u '+%m-%d %H:%M')
          echo "FECHA_ACTUAL=$HOY" >> $GITHUB_ENV
          if [ "$HOY" = "09-30 23:59" ]; then
            echo "desactivar=true" >> $GITHUB_OUTPUT
          else
            echo "desactivar=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ Clonar el repositorio
        if: steps.verificar.outputs.desactivar == 'true'
        uses: actions/checkout@v4

      - name: ğŸ—‘ï¸ Eliminar archivo keep-alive.yml
        if: steps.verificar.outputs.desactivar == 'true'
        run: |
          echo "ğŸ—‚ï¸ Eliminando archivo keep-alive.yml para detener futuros pings..."
          rm -f .github/workflows/keep-alive.yml

      - name: ğŸ“¤ Commit y push del borrado
        if: steps.verificar.outputs.desactivar == 'true'
        run: |
          git config --global user.name "uptime-bot"
          git config --global user.email "uptime@githubactions.com"
          git add .github/workflows/keep-alive.yml || echo "Ya estaba borrado"
          git commit -m "ğŸ›‘ Autoapagado: Fin del ciclo de pings a Render (sept 30)"
          git push
